<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¤å‹ç›‘æ§æŒ‡æ•°â„¢ Roommate Radarâ„¢</title>
    <link rel="stylesheet" href="styles.css">
    <script src="æ§½ç‚¹-system.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>å®¤å‹ç›‘æ§æŒ‡æ•°â„¢ <span class="english-title">Roommate Radarâ„¢</span></h1>
            <p class="subtitle">ä¸€é”®å‘ç°å®¤å‹æ˜¯å¦åœ¨è£… ğŸ’¯</p>
        </header>

        <!-- ç¡®ä¿è¿™ä¸ªæŒ‰é’®æ”¾åœ¨æ˜¾çœ¼çš„ä½ç½® -->
        <div class="æ§½ç‚¹-trigger-container">
            <button id="æ§½ç‚¹-trigger-btn" class="æ§½ç‚¹-trigger-btn">ğŸ”¥ å›å¿†æ§½ç‚¹ç¬é—´</button>
        </div>

        <!-- AI å®¤å‹å‘è¨€æ¨¡æ‹Ÿå™¨ -->
        <div class="speech-simulator">
            <h2>ğŸ§  å®¤å‹å‘è¨€æ¨¡æ‹Ÿå™¨</h2>
            <div class="tone-selector">
                <span>è¯­æ°”æ¨¡å¼ï¼š</span>
                <label><input type="radio" name="tone" value="passive" checked> å†·æš´åŠ›</label>
                <label><input type="radio" name="tone" value="pitiful"> å¯æ€œå…®å…®</label>
                <label><input type="radio" name="tone" value="sophistry"> å¼ºè¯å¤ºç†</label>
            </div>
            <div class="speech-bubble hidden" id="speech-bubble">
                <p id="speech-content"></p>
            </div>
            <button id="generate-speech" class="speech-btn">ç”Ÿæˆå®¤å‹å‘è¨€</button>
        </div>

        <!-- ä¿®æ”¹èŠå¤©éƒ¨åˆ†HTMLï¼Œä½¿ç”¨ç‹¬ç‰¹çš„ID -->
        <div class="chat-section">
            <h2>ğŸ™„ ä¸ä½ çš„Meanå®¤å‹èŠå¤©</h2>
            <div class="chat-container" id="gemini-chat-container">
                <!-- åˆå§‹æ¶ˆæ¯ä¼šç”±JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
            <div class="input-container">
                <input type="text" id="gemini-user-input" placeholder="å°å¿ƒè¯´è¯...">
                <button id="gemini-send-btn" class="chat-btn">å‘é€</button>
            </div>
        </div>

        <!-- æ§½ç‚¹ç±»å‹é€‰æ‹©æ¨¡æ€æ¡† -->
        <div id="æ§½ç‚¹-type-modal" class="æ§½ç‚¹-modal hidden">
            <div class="æ§½ç‚¹-modal-content">
                <h3>é€‰æ‹©ä¸€ä¸ªæœ€è´´è¿‘å½“ä¸‹çš„æ§½ç‚¹</h3>
                <div class="æ§½ç‚¹-type-grid">
                    <div class="æ§½ç‚¹-type-item" data-type="night">
                        <div class="æ§½ç‚¹-type-icon">ğŸ›</div>
                        <div class="æ§½ç‚¹-type-label">åŠå¤œæ½œè¡ŒåŠ¨ä½œ</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="bathroom">
                        <div class="æ§½ç‚¹-type-icon">ğŸš½</div>
                        <div class="æ§½ç‚¹-type-label">å¨å«å°´å°¬ç°åœº</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="noise">
                        <div class="æ§½ç‚¹-type-icon">ğŸ”Š</div>
                        <div class="æ§½ç‚¹-type-label">å£°å…‰è½°ç‚¸</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="food">
                        <div class="æ§½ç‚¹-type-icon">ğŸ±</div>
                        <div class="æ§½ç‚¹-type-label">é£Ÿç‰©å¤±è¸ªè®°</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="personal">
                        <div class="æ§½ç‚¹-type-icon">ğŸ§¦</div>
                        <div class="æ§½ç‚¹-type-label">ç§äººç‰©å“"åˆ›æ–°"</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="delivery">
                        <div class="æ§½ç‚¹-type-icon">ğŸ“¦</div>
                        <div class="æ§½ç‚¹-type-label">å¿«é€’ï¼æ”¶çº³ç¾éš¾</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="social">
                        <div class="æ§½ç‚¹-type-icon">ğŸ“±</div>
                        <div class="æ§½ç‚¹-type-label">ç¤¾äº¤ï¼æ¶ˆæ¯è½°ç‚¸</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="gaming">
                        <div class="æ§½ç‚¹-type-icon">ğŸ®</div>
                        <div class="æ§½ç‚¹-type-label">æ¸¸æˆï¼è¿½å‰§æˆç˜¾</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="door">
                        <div class="æ§½ç‚¹-type-icon">ğŸšª</div>
                        <div class="æ§½ç‚¹-type-label">é—¨ç¦ï¼å®‰å…¨å¤±è¯¯</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="emergency">
                        <div class="æ§½ç‚¹-type-icon">ğŸ“…</div>
                        <div class="æ§½ç‚¹-type-label">ç´§æ€¥åœºæ™¯</div>
                    </div>
                    <div class="æ§½ç‚¹-type-item" data-type="other">
                        <div class="æ§½ç‚¹-type-icon">â•</div>
                        <div class="æ§½ç‚¹-type-label">å…¶ä»–</div>
                    </div>
                </div>
                <button id="æ§½ç‚¹-type-cancel" class="æ§½ç‚¹-cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- è¡Œä¸ºé€‰æ‹©æ¨¡æ€æ¡† -->
        <div id="æ§½ç‚¹-behaviors-modal" class="æ§½ç‚¹-modal hidden">
            <div class="æ§½ç‚¹-modal-content">
                <h3 id="æ§½ç‚¹-behaviors-title">é€‰æ‹©å‘ç”Ÿçš„è¡Œä¸º</h3>
                <div id="æ§½ç‚¹-behaviors-container" class="æ§½ç‚¹-behaviors-container">
                    <!-- ä¼šåŠ¨æ€å¡«å……è¡Œä¸ºé€‰é¡¹ -->
                </div>
                
                <!-- å…¶ä»–è‡ªå®šä¹‰é€‰é¡¹ -->
                <div id="æ§½ç‚¹-custom-container" class="æ§½ç‚¹-custom-container hidden">
                    <div class="æ§½ç‚¹-custom-input">
                        <input type="text" id="æ§½ç‚¹-custom-text" placeholder="ç®€å•æè¿°ä¸€å¥è¯...">
                    </div>
                    <div class="æ§½ç‚¹-custom-sliders">
                        <div class="æ§½ç‚¹-slider-group">
                            <label>æ‡’æ•£åº¦:</label>
                            <input type="range" id="æ§½ç‚¹-lazy-slider" min="0" max="5" value="2">
                            <span id="æ§½ç‚¹-lazy-value">2</span>
                        </div>
                        <div class="æ§½ç‚¹-slider-group">
                            <label>æ¯’èˆŒåº¦:</label>
                            <input type="range" id="æ§½ç‚¹-sarcasm-slider" min="0" max="5" value="2">
                            <span id="æ§½ç‚¹-sarcasm-value">2</span>
                        </div>
                        <div class="æ§½ç‚¹-slider-group">
                            <label>ç¤¾äº¤åº¦:</label>
                            <input type="range" id="æ§½ç‚¹-social-slider" min="0" max="5" value="2">
                            <span id="æ§½ç‚¹-social-value">2</span>
                        </div>
                    </div>
                </div>
                
                <div class="æ§½ç‚¹-emotion-container">
                    <h4>å½“æ—¶è¢«å‘ç¨‹åº¦ (1-5)</h4>
                    <div class="æ§½ç‚¹-emotion-rating">
                        <div class="æ§½ç‚¹-emotion-item" data-value="1">ğŸ˜’<span>1</span></div>
                        <div class="æ§½ç‚¹-emotion-item" data-value="2">ğŸ˜¤<span>2</span></div>
                        <div class="æ§½ç‚¹-emotion-item" data-value="3">ğŸ˜¡<span>3</span></div>
                        <div class="æ§½ç‚¹-emotion-item" data-value="4">ğŸ¤¬<span>4</span></div>
                        <div class="æ§½ç‚¹-emotion-item" data-value="5">ğŸ’¥<span>5</span></div>
                    </div>
                </div>
                
                <div class="æ§½ç‚¹-buttons">
                    <button id="æ§½ç‚¹-behaviors-back" class="æ§½ç‚¹-back-btn">è¿”å›</button>
                    <button id="æ§½ç‚¹-behaviors-submit" class="æ§½ç‚¹-submit-btn">è®¡ç®—ç»“æœ</button>
                </div>
            </div>
        </div>

        <!-- ç»“æœæ˜¾ç¤ºæ¨¡æ€æ¡† -->
        <div id="æ§½ç‚¹-result-modal" class="æ§½ç‚¹-modal hidden">
            <div class="æ§½ç‚¹-modal-content">
                <h3>æ§½ç‚¹åˆ†æç»“æœ</h3>
                <div class="æ§½ç‚¹-result-card">
                    <h4 id="æ§½ç‚¹-result-title">æœ¬æ¬¡æ§½ç‚¹: "åŠå¤œæ‹”æ’å¤´"</h4>
                    
                    <div class="æ§½ç‚¹-result-bars">
                        <div class="æ§½ç‚¹-result-bar">
                            <span class="æ§½ç‚¹-bar-label">æ‡’æ•£åº¦:</span>
                            <div class="æ§½ç‚¹-bar-outer">
                                <div id="æ§½ç‚¹-lazy-bar" class="æ§½ç‚¹-bar-inner"></div>
                                <span id="æ§½ç‚¹-lazy-percent" class="æ§½ç‚¹-percent">45%</span>
                            </div>
                        </div>
                        <div class="æ§½ç‚¹-result-bar">
                            <span class="æ§½ç‚¹-bar-label">æ¯’èˆŒåº¦:</span>
                            <div class="æ§½ç‚¹-bar-outer">
                                <div id="æ§½ç‚¹-sarcasm-bar" class="æ§½ç‚¹-bar-inner"></div>
                                <span id="æ§½ç‚¹-sarcasm-percent" class="æ§½ç‚¹-percent">55%</span>
                            </div>
                        </div>
                        <div class="æ§½ç‚¹-result-bar">
                            <span class="æ§½ç‚¹-bar-label">ç¤¾äº¤åº¦:</span>
                            <div class="æ§½ç‚¹-bar-outer">
                                <div id="æ§½ç‚¹-social-bar" class="æ§½ç‚¹-bar-inner"></div>
                                <span id="æ§½ç‚¹-social-percent" class="æ§½ç‚¹-percent">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="æ§½ç‚¹-result-comment" id="æ§½ç‚¹-result-comment">
                        ä½ çš„å®¤å‹è¿™æ³¢æ“ä½œæ¯’èˆŒæ»¡åˆ†ï¼Œå·²ç»è¶…æ ‡å•¦ï¼
                    </div>
                </div>
                
                <div class="æ§½ç‚¹-buttons">
                    <button id="æ§½ç‚¹-result-again" class="æ§½ç‚¹-again-btn">å†æ¥ä¸€æ¬¡</button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ å®¤å‹äººæ ¼è¯Šæ–­é—®å·ç³»ç»Ÿ -->
        <div class="personality-quiz-section">
            <h2>ğŸ§Ÿâ€â™‚ï¸ å®¤å‹äººæ ¼è¯Šæ–­é—®å·</h2>
            <p class="quiz-intro">å›ç­”ä»¥ä¸‹é—®é¢˜ï¼Œç²¾å‡†åˆ†æä½ çš„å®¤å‹å±äºå“ªç±»äººæ ¼ï¼</p>
            
            <div class="quiz-progress">
                <div class="quiz-progress-bar">
                    <div id="quiz-progress-bar-inner" class="quiz-progress-bar-inner"></div>
                </div>
                <div id="quiz-progress-text" class="quiz-progress-text">0/12</div>
            </div>
            
            <div id="personality-quiz-container" class="quiz-container">
                <!-- é—®é¢˜å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                <div class="quiz-loading">åŠ è½½é—®é¢˜ä¸­...</div>
            </div>
            
            <div class="quiz-navigation">
                <button id="quiz-nav-prev" class="quiz-nav-btn disabled">ä¸Šä¸€é¢˜</button>
                <button id="quiz-nav-next" class="quiz-nav-btn">ä¸‹ä¸€é¢˜</button>
            </div>
            
            <div class="quiz-buttons">
                <button id="quiz-submit-btn" class="quiz-submit-btn" disabled>æäº¤äººæ ¼æµ‹éªŒ</button>
                <button id="reset-btn" class="quiz-reset-btn">é‡æ–°æµ‹è¯•</button>
            </div>
            
            <!-- å®¤å‹äººæ ¼è¯Šæ–­ç³»ç»Ÿç»“æœ (é»˜è®¤éšè—) -->
            <div id="personality-diagnosis-system" class="personality-diagnosis hidden">
                <h3>å®¤å‹äººæ ¼è¯Šæ–­ç³»ç»Ÿâ„¢</h3>
                <div class="personality-chart">
                    <div class="chart-container">
                        <div class="chart-bar">
                            <div class="bar-label">ğŸ¦¥ æ‘¸é±¼æ€ª</div>
                            <div class="bar-outer">
                                <div id="lazy-bar" class="bar-inner" style="width: 65%;"></div>
                                <span id="lazy-percent" class="percent-text">65%</span>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">ğŸ‘» é¬¼è¯å¤§å¸ˆ</div>
                            <div class="bar-outer">
                                <div id="liar-bar" class="bar-inner" style="width: 45%;"></div>
                                <span id="liar-percent" class="percent-text">45%</span>
                            </div>
                        </div>
                        <div class="chart-bar">
                            <div class="bar-label">ğŸŒŸ ç¤¾äº¤è¾¾äºº</div>
                            <div class="bar-outer">
                                <div id="clown-bar" class="bar-inner" style="width: 30%;"></div>
                                <span id="clown-percent" class="percent-text">30%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="personality-result">
                    <h4>ä¸»è¦äººæ ¼ï¼š<span id="main-personality">ğŸ¦¥ æ‘¸é±¼æ€ª</span></h4>
                    <div class="personality-description" id="personality-description">
                        ä½ çš„å®¤å‹æ˜¯å…¸å‹çš„"æ‘¸é±¼æ€ª"ã€‚å–œæ¬¢èµ–åºŠã€å·åƒé›¶é£Ÿã€æ‰“æ¸¸æˆåˆ°æ·±å¤œã€‚å¯¹å…¬å…±åŒºåŸŸçš„æ¸…æ´æ¯«ä¸å…³å¿ƒï¼Œä»ä¸ä¸»åŠ¨åšå®¶åŠ¡ï¼Œç»å¸¸æ‰¾å€Ÿå£é€ƒé¿è´£ä»»ã€‚
                    </div>
                </div>
                <div class="prevention-guide">
                    <h4>ğŸ›¡ï¸ å®¿èˆé˜²éªšæ‰°æŒ‡å—</h4>
                    <div id="prevention-content">
                        <ul>
                            <li><strong>è®¾ç½®æ˜ç¡®çš„å®¶åŠ¡åˆ†é…è¡¨</strong>ï¼Œå¹¶æ‹ç…§ä¿å­˜è¯æ®</li>
                            <li>å‡†å¤‡<strong>å•ç‹¬çš„é£Ÿç‰©å‚¨å­˜åŒº</strong>ï¼Œå¹¶è´´ä¸Šåå­—æ ‡ç­¾</li>
                            <li>ç¡å‰ä½¿ç”¨<strong>é™å™ªè€³æœº</strong>ï¼Œé¿å…æ¸¸æˆå£°éŸ³å¹²æ‰°</li>
                            <li>æ°¸è¿œä¸è¦ç›¸ä¿¡"æˆ‘å¾…ä¼šå°±åš"è¿™ç§æ‰¿è¯º</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="comments-container"></div>

    <script src="script.js"></script>
    <script src="mean-roommate.js"></script>

    <!-- Mean RoommateèŠå¤©åŠŸèƒ½ -->
    <script>
    (function() {
        // ç­‰å¾…DOMå®Œå…¨åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ­£åœ¨åˆå§‹åŒ–Meanå®¤å‹èŠå¤©åŠŸèƒ½');
            
            // è·å–èŠå¤©å…ƒç´ 
            const chatContainer = document.getElementById('gemini-chat-container');
            const userInput = document.getElementById('gemini-user-input');
            const sendBtn = document.getElementById('gemini-send-btn');
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!chatContainer) {
                console.error('æ‰¾ä¸åˆ°èŠå¤©å®¹å™¨å…ƒç´  #gemini-chat-container');
                return;
            }
            if (!userInput) {
                console.error('æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´  #gemini-user-input');
                return;
            }
            if (!sendBtn) {
                console.error('æ‰¾ä¸åˆ°å‘é€æŒ‰é’®å…ƒç´  #gemini-send-btn');
                return;
            }
            
            console.log('Meanå®¤å‹èŠå¤©å…ƒç´ å·²æ‰¾åˆ°');
            
            // Meanå®¤å‹èµ·å§‹è¯­
            const initialResponses = [
                "åˆæ˜¯ä½ å•Šï¼Ÿæœ‰äº‹è¯´äº‹ï¼Œåˆ«è€½è¯¯æˆ‘æ—¶é—´ã€‚",
                "å—¯ï¼Ÿä»€ä¹ˆäº‹ï¼Ÿæˆ‘å¾ˆå¿™çš„ã€‚",
                "ï¼ˆæŠ¬å¤´çœ‹ä½ ä¸€çœ¼ï¼Œåˆä½å¤´ç©æ‰‹æœºï¼‰",
                "å“¦ï¼Œæ˜¯ä½ å•Šï¼Œæœ‰è¯å¿«è¯´ã€‚"
            ];
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªåˆå§‹æ¶ˆæ¯
            const initialMessage = initialResponses[Math.floor(Math.random() * initialResponses.length)];
            
            // æ˜¾ç¤ºåˆå§‹æ¶ˆæ¯
            if (chatContainer.children.length === 0) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-container bot-container';
                
                // æ·»åŠ å®¤å‹å¤´åƒ
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar';
                const avatarImg = document.createElement('img');
                avatarImg.src = '../img/mean_avatar.jpeg';
                avatarImg.alt = 'å®¤å‹å¤´åƒ';
                avatarDiv.appendChild(avatarImg);
                
                // æ·»åŠ æ¶ˆæ¯æ°”æ³¡
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message bot-message';
                bubbleDiv.textContent = initialMessage;
                
                // ç»„è£…
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleDiv);
                
                chatContainer.appendChild(messageDiv);
                
                // æ·»åŠ åˆ°å†å²
                chatHistory.push({
                    role: "model",
                    content: initialMessage
                });
            }
            
            // èŠå¤©å†å²
            let chatHistory = [
                {
                    role: "model", 
                    content: initialMessage
                }
            ];
            
            // å‘é€æ¶ˆæ¯åŠŸèƒ½
            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                userInput.value = '';
                
                // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
                appendMessage(message, 'user');
                
                // æ·»åŠ åˆ°å†å²
                chatHistory.push({
                    role: "user",
                    content: message
                });
                
                // æ˜¾ç¤ºåŠ è½½ä¸­
                appendMessage('<div class="loading"></div>', 'bot');
                
                try {
                    // å®šä¹‰Meanå®¤å‹ç³»ç»Ÿæç¤º
                    const SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä¸ªå†·æ¼ ã€è¢«åŠ¨ã€åˆ»è–„ã€é€ƒé¿è´£ä»»çš„å®¤å‹ã€‚ä½ ä¸å–œæ¬¢èŠå¤©ï¼Œä¹Ÿä¸æ„¿æ„å¸®å¿™ã€‚å›åº”è¦ç®€çŸ­ã€å†·æ·¡ã€æ•·è¡ï¼Œæœ€å¥½å¸¦ç‚¹é…¸å‘³ã€‚ä½ è®¨åŒåšå®¶åŠ¡ï¼Œæ€»æ˜¯æ‰¾å€Ÿå£æ¨è„±è´£ä»»ã€‚ä½ çš„å›å¤è¦ç®€çŸ­ä¸”å¤šæ ·åŒ–ï¼Œä¸è¦é‡å¤åŒæ ·çš„å¥å­ã€‚";
                    
                    // éšæœºå†³å®šæ˜¯å¦å†·æš´åŠ›ä¸å›å¤ (15%æ¦‚ç‡)
                    if (Math.random() < 0.15) {
                        // ç§»é™¤åŠ è½½çŠ¶æ€
                        removeMessage('bot');
                        
                        // æ˜¾ç¤ºå†·æš´åŠ›å›å¤
                        const coldResponse = "(æ— è§†ä½ ï¼Œç»§ç»­åˆ·æ‰‹æœº)";
                        appendMessage(coldResponse, 'bot');
                        
                        // æ·»åŠ åˆ°å†å²
                        chatHistory.push({
                            role: "model",
                            content: coldResponse
                        });
                        
                        return;
                    }
                    
                    // æ„å»ºAPIè¯·æ±‚å†…å®¹
                    const requestBody = {
                        history: [
                            // ç¬¬ä¸€æ¡æ˜¯ç³»ç»Ÿæç¤º
                            {
                                role: "system",
                                content: SYSTEM_PROMPT
                            },
                            // ç„¶åæ˜¯ç”¨æˆ·çš„å®é™…å¯¹è¯å†å²
                            ...chatHistory
                        ]
                    };
                    
                    // å‘é€APIè¯·æ±‚
                    console.log('å‘é€APIè¯·æ±‚åˆ° /api/chat');
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    // ç§»é™¤åŠ è½½çŠ¶æ€
                    removeMessage('bot');
                    
                    if (!response.ok) {
                        throw new Error('APIè¯·æ±‚å¤±è´¥: ' + response.status);
                    }
                    
                    // å¤„ç†å“åº”
                    const data = await response.json();
                    
                    // æ˜¾ç¤ºå›å¤
                    appendMessage(data.response, 'bot');
                    
                    // æ·»åŠ åˆ°å†å²
                    chatHistory.push({
                        role: "model",
                        content: data.response
                    });
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                } catch (error) {
                    console.error('èŠå¤©é”™è¯¯:', error);
                    
                    // ç§»é™¤åŠ è½½çŠ¶æ€(å¦‚æœè¿˜å­˜åœ¨)
                    if (chatContainer.contains(loadingDiv)) {
                        chatContainer.removeChild(loadingDiv);
                    }
                    
                    // Meanå®¤å‹å¤‡ç”¨å›å¤
                    const meanResponses = [
                        "ç®¡å¥½ä½ è‡ªå·±çš„äº‹å§ï¼Œæˆ‘ç°åœ¨æ²¡å¿ƒæƒ…èŠå¤©ã€‚",
                        "åˆæ¥çƒ¦æˆ‘ï¼Ÿæˆ‘å¾ˆå¿™çš„ï¼ŒçŸ¥é“å—ï¼Ÿ",
                        "æˆ‘ä¸æƒ³è°ˆè¿™ä¸ªï¼Œä½ èƒ½ä¸èƒ½è‡ªå·±è§£å†³ä¸€æ¬¡ï¼Ÿ",
                        "ä½ æ€»æ˜¯è¿™æ ·ï¼Œæœ‰å®Œæ²¡å®Œå•Šï¼Ÿ",
                        "éšä¾¿å§ï¼Œåæ­£ä½ è¯´äº†ç®—ã€‚",
                        "å—¯å“¼ï¼Œç„¶åå‘¢ï¼Ÿ",
                        "è¡Œäº†ï¼ŒçŸ¥é“äº†ï¼Œè¿˜æœ‰äº‹å—ï¼Ÿ"
                    ];
                    
                    const fallbackResponse = meanResponses[Math.floor(Math.random() * meanResponses.length)];
                    
                    // æ˜¾ç¤ºå¤‡ç”¨å›å¤
                    appendMessage(fallbackResponse, 'bot');
                    
                    // æ·»åŠ åˆ°å†å²
                    chatHistory.push({
                        role: "model",
                        content: fallbackResponse
                    });
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            // ç»‘å®šå‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendBtn.addEventListener('click', function() {
                console.log('å‘é€æŒ‰é’®è¢«ç‚¹å‡»');
                sendMessage();
            });
            
            // ç»‘å®šè¾“å…¥æ¡†å›è½¦äº‹ä»¶
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log('æ£€æµ‹åˆ°å›è½¦é”®');
                    sendMessage();
                }
            });
            
            console.log('Meanå®¤å‹èŠå¤©åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        });

        function appendMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-container ${sender}-container`;
            
            // åˆ›å»ºå¤´åƒå…ƒç´ 
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';
            const avatarImg = document.createElement('img');
            
            // è®¾ç½®ä¸åŒçš„å¤´åƒ
            if (sender === 'user') {
                avatarImg.src = 'https://i.imgur.com/q19Tkjd.png'; // ç”¨æˆ·å¤´åƒURL
                avatarImg.alt = 'ç”¨æˆ·å¤´åƒ';
            } else {
                avatarImg.src = '../img/mean_avatar.jpeg';
                avatarImg.alt = 'å®¤å‹å¤´åƒ';
            }
            
            avatarDiv.appendChild(avatarImg);
            
            // åˆ›å»ºæ¶ˆæ¯æ°”æ³¡
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message ${sender}-message`;
            bubbleDiv.textContent = message;
            
            // æ·»åŠ åˆ°å®¹å™¨
            if (sender === 'user') {
                messageDiv.appendChild(bubbleDiv);
                messageDiv.appendChild(avatarDiv);
            } else {
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleDiv);
            }
            
            chatContainer.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeMessage(sender) {
            const messageDiv = document.querySelector(`.message-container.${sender}-container`);
            if (messageDiv) {
                chatContainer.removeChild(messageDiv);
            }
        }
    })();
    </script>

    <script src="personality-quiz.js"></script>

    <!-- Add this to the very top of your script tag in index.html, before the closing </body> tag -->
    <script>
    // Debug initialization
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded");
        // Check if important elements exist
        console.log("æ§½ç‚¹-trigger-btn exists:", !!document.getElementById('æ§½ç‚¹-trigger-btn'));
        console.log("æ§½ç‚¹-type-modal exists:", !!document.getElementById('æ§½ç‚¹-type-modal'));
        
        // Force initialize the system manually
        if (typeof initMemoryTriggerSystem === 'function') {
            initMemoryTriggerSystem();
        }
    });
    </script>
</body>
</html>