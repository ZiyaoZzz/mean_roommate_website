<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¤å‹ç›‘æ§æŒ‡æ•°â„¢ Roommate Radarâ„¢</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>å®¤å‹ç›‘æ§æŒ‡æ•°â„¢ <span class="english-title">Roommate Radarâ„¢</span></h1>
            <p class="subtitle">ä¸€é”®å‘ç°å®¤å‹æ˜¯å¦åœ¨è£… ğŸ’¯</p>
        </header>

        <!-- AI å®¤å‹å‘è¨€æ¨¡æ‹Ÿå™¨ -->
        <div class="speech-simulator">
            <h2>ğŸ§  å®¤å‹å‘è¨€æ¨¡æ‹Ÿå™¨</h2>
            <div class="tone-selector">
                <span>è¯­æ°”æ¨¡å¼ï¼š</span>
                <label><input type="radio" name="tone" value="passive" checked> å†·æš´åŠ›</label>
                <label><input type="radio" name="tone" value="pitiful"> å¯æ€œå…®å…®</label>
                <label><input type="radio" name="tone" value="sophistry"> å¼ºè¯å¤ºç†</label>
            </div>
            <div class="speech-bubble hidden" id="speech-bubble">
                <p id="speech-content"></p>
            </div>
            <button id="generate-speech" class="speech-btn">ç”Ÿæˆå®¤å‹å‘è¨€</button>
        </div>
        <!-- ä¿®æ”¹èŠå¤©éƒ¨åˆ†HTMLï¼Œä½¿ç”¨ç‹¬ç‰¹çš„ID -->
        <div class="chat-section">
            <h2>ğŸ™„ ä¸ä½ çš„Meanå®¤å‹èŠå¤©</h2>
            <div class="chat-container" id="gemini-chat-container">
                <!-- åˆå§‹æ¶ˆæ¯ä¼šç”±JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
            <div class="input-container">
                <input type="text" id="gemini-user-input" placeholder="å°å¿ƒè¯´è¯...">
                <button id="gemini-send-btn" class="chat-btn">å‘é€</button>
            </div>
        </div>
        <form id="roommateForm">
            <div class="form-section">
                <h2>æ—¥å¸¸è¡Œä¸º</h2>
                
                <div class="form-item">
                    <input type="checkbox" id="dishes" name="dishes">
                    <label for="dishes">ä»Šå¤©æ´—ç¢—äº†å—ï¼Ÿ</label>
                </div>
                
                <div class="form-item">
                    <input type="checkbox" id="shampoo" name="shampoo">
                    <label for="shampoo">ç”¨äº†ä½ çš„æ´—å‘æ°´ï¼Ÿ</label>
                </div>
                
                <div class="form-item">
                    <input type="checkbox" id="noise" name="noise">
                    <label for="noise">åŠå¤œæ‰“æ¸¸æˆåˆ°3ç‚¹ï¼Ÿ</label>
                </div>
                
                <div class="form-item">
                    <input type="checkbox" id="trash" name="trash">
                    <label for="trash">å¿˜è®°å€’åƒåœ¾ï¼Ÿ</label>
                </div>
                
                <div class="form-item">
                    <input type="checkbox" id="food" name="food">
                    <label for="food">å·åƒä½ çš„é›¶é£Ÿï¼Ÿ</label>
                </div>
            </div>

            <div class="form-section">
                <h2>ä½œæ¯æ—¶é—´</h2>
                
                <div class="form-item">
                    <label for="wake_time">èµ·åºŠæ—¶é—´ï¼š</label>
                    <input type="time" id="wake_time" name="wake_time">
                </div>
                
                <div class="form-item">
                    <label for="sleep_time">ç¡è§‰æ—¶é—´ï¼š</label>
                    <input type="time" id="sleep_time" name="sleep_time">
                </div>
            </div>

            <div class="form-section">
                <h2>ç¤¾äº¤æ–¹é¢</h2>
                
                <div class="form-item">
                    <input type="checkbox" id="visitors" name="visitors">
                    <label for="visitors">ä¸å‘ŠçŸ¥å°±å¸¦æœ‹å‹å›æ¥ï¼Ÿ</label>
                </div>
                
                <div class="form-item">
                    <input type="checkbox" id="noisy_calls" name="noisy_calls">
                    <label for="noisy_calls">å¤§å£°è¯­éŸ³é€šè¯ï¼Ÿ</label>
                </div>
            </div>

            <button type="submit" class="calculate-btn">è®¡ç®—è£…æŒ‡æ•°</button>
        </form>

        <div id="result" class="hidden">
            <h2 id="score-title">è®¡ç®—ä¸­...</h2>
            <div class="score-container">
                <div class="score-circle">
                    <span id="score-value">0</span>
                </div>
            </div>
            <img id="avatar" src="" alt="å®¤å‹çŠ¶æ€">
            <p id="comment"></p>
            <button id="share-btn">åˆ†äº«ç›‘æ§æŠ¥å‘Š</button>
            <button id="reset-btn">é‡æ–°è¯„ä¼°</button>
        </div>


    </div>

    <div id="comments-container"></div>

    <script src="script.js"></script>
    <script src="mean-roommate.js"></script>

    <!-- Mean RoommateèŠå¤©åŠŸèƒ½ -->
    <script>
    (function() {
        // ç­‰å¾…DOMå®Œå…¨åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ­£åœ¨åˆå§‹åŒ–Meanå®¤å‹èŠå¤©åŠŸèƒ½');
            
            // è·å–èŠå¤©å…ƒç´ 
            const chatContainer = document.getElementById('gemini-chat-container');
            const userInput = document.getElementById('gemini-user-input');
            const sendBtn = document.getElementById('gemini-send-btn');
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!chatContainer) {
                console.error('æ‰¾ä¸åˆ°èŠå¤©å®¹å™¨å…ƒç´  #gemini-chat-container');
                return;
            }
            if (!userInput) {
                console.error('æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´  #gemini-user-input');
                return;
            }
            if (!sendBtn) {
                console.error('æ‰¾ä¸åˆ°å‘é€æŒ‰é’®å…ƒç´  #gemini-send-btn');
                return;
            }
            
            console.log('Meanå®¤å‹èŠå¤©å…ƒç´ å·²æ‰¾åˆ°');
            
            // Meanå®¤å‹èµ·å§‹è¯­
            const initialResponses = [
                "åˆæ˜¯ä½ å•Šï¼Ÿæœ‰äº‹è¯´äº‹ï¼Œåˆ«è€½è¯¯æˆ‘æ—¶é—´ã€‚",
                "å—¯ï¼Ÿä»€ä¹ˆäº‹ï¼Ÿæˆ‘å¾ˆå¿™çš„ã€‚",
                "ï¼ˆæŠ¬å¤´çœ‹ä½ ä¸€çœ¼ï¼Œåˆä½å¤´ç©æ‰‹æœºï¼‰",
                "å“¦ï¼Œæ˜¯ä½ å•Šï¼Œæœ‰è¯å¿«è¯´ã€‚"
            ];
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªåˆå§‹æ¶ˆæ¯
            const initialMessage = initialResponses[Math.floor(Math.random() * initialResponses.length)];
            
            // ç¡®ä¿åˆå§‹æ¶ˆæ¯æ˜¾ç¤ºåœ¨å®¹å™¨ä¸­
            if (chatContainer.children.length === 0) {
                const initialMessageDiv = document.createElement('div');
                initialMessageDiv.className = 'message bot-message';
                initialMessageDiv.textContent = initialMessage;
                chatContainer.appendChild(initialMessageDiv);
            }
            
            // èŠå¤©å†å²
            let chatHistory = [
                {
                    role: "model", 
                    content: initialMessage
                }
            ];
            
            // å‘é€æ¶ˆæ¯åŠŸèƒ½
            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                userInput.value = '';
                
                // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'message user-message';
                userMessageDiv.textContent = message;
                chatContainer.appendChild(userMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // æ·»åŠ åˆ°å†å²
                chatHistory.push({
                    role: "user",
                    content: message
                });
                
                // æ˜¾ç¤ºåŠ è½½ä¸­
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message bot-message';
                loadingDiv.innerHTML = '<div class="loading"></div>';
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                try {
                    // å®šä¹‰Meanå®¤å‹ç³»ç»Ÿæç¤º
                    const SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä¸ªå†·æ¼ ã€è¢«åŠ¨ã€åˆ»è–„ã€é€ƒé¿è´£ä»»çš„å®¤å‹ã€‚ä½ ä¸å–œæ¬¢èŠå¤©ï¼Œä¹Ÿä¸æ„¿æ„å¸®å¿™ã€‚å›åº”è¦ç®€çŸ­ã€å†·æ·¡ã€æ•·è¡ï¼Œæœ€å¥½å¸¦ç‚¹é…¸å‘³ã€‚ä½ è®¨åŒåšå®¶åŠ¡ï¼Œæ€»æ˜¯æ‰¾å€Ÿå£æ¨è„±è´£ä»»ã€‚ä½ çš„å›å¤è¦ç®€çŸ­ä¸”å¤šæ ·åŒ–ï¼Œä¸è¦é‡å¤åŒæ ·çš„å¥å­ã€‚";
                    
                    // éšæœºå†³å®šæ˜¯å¦å†·æš´åŠ›ä¸å›å¤ (15%æ¦‚ç‡)
                    if (Math.random() < 0.15) {
                        // ç§»é™¤åŠ è½½çŠ¶æ€
                        chatContainer.removeChild(loadingDiv);
                        
                        // æ˜¾ç¤ºå†·æš´åŠ›å›å¤
                        const coldResponse = "(æ— è§†ä½ ï¼Œç»§ç»­åˆ·æ‰‹æœº)";
                        const responseDiv = document.createElement('div');
                        responseDiv.className = 'message bot-message';
                        responseDiv.textContent = coldResponse;
                        chatContainer.appendChild(responseDiv);
                        
                        // æ·»åŠ åˆ°å†å²
                        chatHistory.push({
                            role: "model",
                            content: coldResponse
                        });
                        
                        return;
                    }
                    
                    // æ„å»ºAPIè¯·æ±‚å†…å®¹
                    const requestBody = {
                        history: [
                            // ç¬¬ä¸€æ¡æ˜¯ç³»ç»Ÿæç¤º
                            {
                                role: "system",
                                content: SYSTEM_PROMPT
                            },
                            // ç„¶åæ˜¯ç”¨æˆ·çš„å®é™…å¯¹è¯å†å²
                            ...chatHistory
                        ]
                    };
                    
                    // å‘é€APIè¯·æ±‚
                    console.log('å‘é€APIè¯·æ±‚åˆ° /api/chat');
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    // ç§»é™¤åŠ è½½çŠ¶æ€
                    chatContainer.removeChild(loadingDiv);
                    
                    if (!response.ok) {
                        throw new Error('APIè¯·æ±‚å¤±è´¥: ' + response.status);
                    }
                    
                    // å¤„ç†å“åº”
                    const data = await response.json();
                    
                    // æ˜¾ç¤ºå›å¤
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'message bot-message';
                    responseDiv.textContent = data.response;
                    chatContainer.appendChild(responseDiv);
                    
                    // æ·»åŠ åˆ°å†å²
                    chatHistory.push({
                        role: "model",
                        content: data.response
                    });
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                } catch (error) {
                    console.error('èŠå¤©é”™è¯¯:', error);
                    
                    // ç§»é™¤åŠ è½½çŠ¶æ€(å¦‚æœè¿˜å­˜åœ¨)
                    if (chatContainer.contains(loadingDiv)) {
                        chatContainer.removeChild(loadingDiv);
                    }
                    
                    // Meanå®¤å‹å¤‡ç”¨å›å¤
                    const meanResponses = [
                        "ç®¡å¥½ä½ è‡ªå·±çš„äº‹å§ï¼Œæˆ‘ç°åœ¨æ²¡å¿ƒæƒ…èŠå¤©ã€‚",
                        "åˆæ¥çƒ¦æˆ‘ï¼Ÿæˆ‘å¾ˆå¿™çš„ï¼ŒçŸ¥é“å—ï¼Ÿ",
                        "æˆ‘ä¸æƒ³è°ˆè¿™ä¸ªï¼Œä½ èƒ½ä¸èƒ½è‡ªå·±è§£å†³ä¸€æ¬¡ï¼Ÿ",
                        "ä½ æ€»æ˜¯è¿™æ ·ï¼Œæœ‰å®Œæ²¡å®Œå•Šï¼Ÿ",
                        "éšä¾¿å§ï¼Œåæ­£ä½ è¯´äº†ç®—ã€‚",
                        "å—¯å“¼ï¼Œç„¶åå‘¢ï¼Ÿ",
                        "è¡Œäº†ï¼ŒçŸ¥é“äº†ï¼Œè¿˜æœ‰äº‹å—ï¼Ÿ"
                    ];
                    
                    const fallbackResponse = meanResponses[Math.floor(Math.random() * meanResponses.length)];
                    
                    // æ˜¾ç¤ºå¤‡ç”¨å›å¤
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'message bot-message';
                    responseDiv.textContent = fallbackResponse;
                    chatContainer.appendChild(responseDiv);
                    
                    // æ·»åŠ åˆ°å†å²
                    chatHistory.push({
                        role: "model",
                        content: fallbackResponse
                    });
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            // ç»‘å®šå‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendBtn.addEventListener('click', function() {
                console.log('å‘é€æŒ‰é’®è¢«ç‚¹å‡»');
                sendMessage();
            });
            
            // ç»‘å®šè¾“å…¥æ¡†å›è½¦äº‹ä»¶
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log('æ£€æµ‹åˆ°å›è½¦é”®');
                    sendMessage();
                }
            });
            
            console.log('Meanå®¤å‹èŠå¤©åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        });
    })();
    </script>
</body>
</html>